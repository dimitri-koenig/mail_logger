name: Tasks

on: [push, pull_request]
env:
  DB_DATABASE: typo3_test
  DB_USER: root
  DB_PASSWORD: root
jobs:
  lint-php:
    name: php:${{ matrix.php }} TYPO3:${{ matrix.typo3 }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: [ 7.2, 7.3, 7.4, 8.0, 8.1 ]
        typo3: [ 10, 11 ]
        exclude:
          - php: 7.2
            typo3: 11
          - php: 7.3
            typo3: 11

          - php: 8.0
            typo3: 10
          - php: 8.1
            typo3: 10
    steps:
      - name: Setup PHP with PECL extension
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
      - name: Set up MySQL
        run: |
          sudo /etc/init.d/mysql start
          mysql -e 'CREATE DATABASE ${{ env.DB_DATABASE }};' -u${{ env.DB_USER }} -p${{ env.DB_PASSWORD }}
      - uses: actions/checkout@v2
      - uses: actions/cache@v2
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-${{ matrix.php }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.php }}-composer-
      - run: composer require typo3/minimal="^${{ matrix.typo3 }}" --dev
      - run: composer install --no-interaction --no-progress
      - run: ./vendor/bin/grumphp run --ansi
      - run: composer test
